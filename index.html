<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mmm Food - Macro Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Mmm Food">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#3b82f6">
    
    <!-- App Icons -->
    <link rel="apple-touch-icon" href="icons/food-svgrepo-com.svg">
    <link rel="icon" type="image/svg+xml" href="icons/food-svgrepo-com.svg">
    <link rel="mask-icon" href="icons/food-svgrepo-com.svg" color="#3b82f6">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.1/dist/pocketbase.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" x-data="foodTracker()" class="container mx-auto px-4 py-6 max-w-md">
        <!-- Loading State -->
        <div x-show="isLoading" class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p class="text-gray-600">Loading...</p>
            </div>
        </div>

        <!-- Auth Error State -->
        <div x-show="!isLoading && authError" class="flex items-center justify-center min-h-screen">
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded max-w-md">
                <p class="font-bold">Authentication Error</p>
                <p x-text="authError"></p>
                <button @click="window.location.reload()"
                        class="mt-4 bg-red-500 text-white px-4 py-2 rounded-lg">
                    Try Again
                </button>
            </div>
        </div>

        <!-- Main App (only show when authenticated) -->
        <div x-show="!isLoading && isAuthenticated && !authError">
            <!-- Navigation -->
            <nav class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Mmm Food</h1>
                <button @click="if (!showSettings) { refreshSettings(); } showSettings = !showSettings"
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg">
                    <span x-show="!showSettings">Settings</span>
                    <span x-show="showSettings">Tracker</span>
                </button>
            </nav>

        <!-- Main Tracker View -->
        <div x-show="!showSettings" x-transition>
            <!-- Auto-save Success Message -->
            <div x-show="autoSaveMessage"
                 x-transition
                 class="mb-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                <p x-text="autoSaveMessage"></p>
            </div>

            <!-- Date Change Warning -->
            <div x-show="dateChangeWarning"
                 class="mb-4 bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">
                <p x-text="dateChangeWarning" class="text-sm"></p>
                <button @click="dateChangeWarning = null" class="text-xs underline mt-1">
                    Dismiss
                </button>
            </div>

            <!-- Total Calories Display -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 text-center">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">Today's Calories</h2>
                <div class="text-4xl font-bold text-blue-600" x-text="totalCalories"></div>
                <p class="text-sm text-gray-600" x-text="'Target: ' + targetCalories"></p>

                <!-- Action Buttons -->
                <div class="flex gap-2 mt-4 justify-center">
                    <button @click="resetDaily()"
                            :disabled="isResetting"
                            :class="isResetting ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-600'"
                            class="bg-gray-500 text-white px-4 py-2 rounded-lg text-sm">
                        <span x-show="!isResetting">Sync</span>
                        <span x-show="isResetting">Saving...</span>
                    </button>

                    <button @click="openWeightDialog()"
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600">
                        Log Weight
                    </button>
                </div>

                <!-- Reset Error Message -->
                <div x-show="resetError" class="mt-3 bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded text-sm">
                    <p x-text="resetError"></p>
                    <button @click="resetError = null" class="text-xs underline mt-1">
                        Dismiss
                    </button>
                </div>
            </div>

            <!-- Macro Counters -->
            <div class="space-y-4">
                <!-- Protein -->
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold text-gray-800">Protein</h3>
                            <p class="text-sm text-gray-600" x-text="'Target: ' + targets.protein + ' servings'"></p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button @click="decrementMacro('protein')" 
                                    class="bg-red-500 text-white w-12 h-12 rounded-full text-xl font-bold">-</button>
                            <span class="text-2xl font-bold w-8 text-center" 
                                  :class="protein > targets.protein ? 'text-red-400' : 'text-gray-800'" 
                                  x-text="protein"></span>
                            <button @click="incrementMacro('protein')" 
                                    class="bg-green-500 text-white w-12 h-12 rounded-full text-xl font-bold">+</button>
                        </div>
                    </div>
                </div>

                <!-- Carbohydrates -->
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold text-gray-800">Carbohydrates</h3>
                            <p class="text-sm text-gray-600" x-text="'Target: ' + targets.carbs + ' servings'"></p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button @click="decrementMacro('carbs')" 
                                    class="bg-red-500 text-white w-12 h-12 rounded-full text-xl font-bold">-</button>
                            <span class="text-2xl font-bold w-8 text-center" 
                                  :class="carbs > targets.carbs ? 'text-red-400' : 'text-gray-800'" 
                                  x-text="carbs"></span>
                            <button @click="incrementMacro('carbs')" 
                                    class="bg-green-500 text-white w-12 h-12 rounded-full text-xl font-bold">+</button>
                        </div>
                    </div>
                </div>

                <!-- Fat -->
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold text-gray-800">Fat</h3>
                            <p class="text-sm text-gray-600" x-text="'Target: ' + targets.fat + ' servings'"></p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button @click="decrementMacro('fat')" 
                                    class="bg-red-500 text-white w-12 h-12 rounded-full text-xl font-bold">-</button>
                            <span class="text-2xl font-bold w-8 text-center" 
                                  :class="fat > targets.fat ? 'text-red-400' : 'text-gray-800'" 
                                  x-text="fat"></span>
                            <button @click="incrementMacro('fat')" 
                                    class="bg-green-500 text-white w-12 h-12 rounded-full text-xl font-bold">+</button>
                        </div>
                    </div>
                </div>

                <!-- Alcohol -->
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold text-gray-800">Alcohol</h3>
                            <p class="text-sm text-gray-600" x-text="'Target: ' + targets.alcohol + ' servings'"></p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button @click="decrementMacro('alcohol')" 
                                    class="bg-red-500 text-white w-12 h-12 rounded-full text-xl font-bold">-</button>
                            <span class="text-2xl font-bold w-8 text-center" 
                                  :class="alcohol > targets.alcohol ? 'text-red-400' : 'text-gray-800'" 
                                  x-text="alcohol"></span>
                            <button @click="incrementMacro('alcohol')" 
                                    class="bg-green-500 text-white w-12 h-12 rounded-full text-xl font-bold">+</button>
                        </div>
                    </div>
                </div>

                <!-- Macronutrient Grams Summary -->
                <div class="bg-white rounded-lg shadow-md p-4 mt-6">
                    <h3 class="font-semibold text-gray-800 mb-3">Grams Consumed</h3>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Protein:</span>
                            <span class="font-semibold" x-text="proteinGrams + 'g'"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Carbs:</span>
                            <span class="font-semibold" x-text="carbGrams + 'g'"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Fat:</span>
                            <span class="font-semibold" x-text="fatGrams + 'g'"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Alcohol:</span>
                            <span class="font-semibold" x-text="alcoholGrams + 'g'"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div x-show="showSettings" x-transition>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Daily Targets</h2>

                <!-- Loading Settings Indicator -->
                <div x-show="isLoadingSettings" class="mb-4 flex items-center text-sm text-gray-600">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500 mr-2"></div>
                    <span>Loading settings...</span>
                </div>

                <!-- Using Cached Settings Warning -->
                <div x-show="usingCachedSettings && !isLoadingSettings"
                     class="mb-4 bg-yellow-100 border border-yellow-400 text-yellow-700 px-3 py-2 rounded text-sm">
                    <p>Using cached settings (offline). Changes will sync when online.</p>
                </div>

                <!-- Settings Error Message -->
                <div x-show="settingsError"
                     class="mb-4 bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded text-sm">
                    <p x-text="settingsError"></p>
                    <button @click="settingsError = null" class="text-xs underline mt-1">
                        Dismiss
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Protein (servings)</label>
                        <input type="number" inputmode="numeric" x-model="targets.protein"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Carbohydrates (servings)</label>
                        <input type="number" inputmode="numeric" x-model="targets.carbs"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fat (servings)</label>
                        <input type="number" inputmode="numeric" x-model="targets.fat"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Alcohol (servings)</label>
                        <input type="number" inputmode="numeric" x-model="targets.alcohol"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Additional Fat % (for protein/carbs)</label>
                        <input type="number" inputmode="decimal" x-model="additionalFatPercent" min="0" max="100" step="0.1"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        <p class="text-xs text-gray-500 mt-1">Percentage of additional fat grams added to protein and carb servings</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Calorie Expenditure</label>
                        <div class="flex gap-2">
                            <input type="number" inputmode="numeric" x-model="calorieExpenditure" min="0" step="1"
                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2">
                            <button @click="recomputeCalorieExpenditure()"
                                    :disabled="isRecomputing"
                                    :class="isRecomputing ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-600'"
                                    class="bg-green-500 text-white px-3 py-2 rounded-lg text-sm whitespace-nowrap">
                                <span x-show="!isRecomputing">Recompute</span>
                                <span x-show="isRecomputing">Computing...</span>
                            </button>
                        </div>
                        <!-- Recompute Error Message -->
                        <div x-show="recomputeError" class="mt-2 bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded text-sm">
                            <p x-text="recomputeError"></p>
                            <button @click="recomputeError = null" class="text-xs underline mt-1">
                                Dismiss
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Delta lb/week</label>
                        <input type="number" inputmode="decimal" x-model="deltaLbPerWeek" step="0.1"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>
                </div>

                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-2">Target Calories</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>Protein: <span x-text="Math.round(targets.protein * getProteinCaloriesPerServing())"></span> cal</div>
                        <div>Carbs: <span x-text="Math.round(targets.carbs * getCarbCaloriesPerServing())"></span> cal</div>
                        <div>Fat: <span x-text="Math.round(targets.fat * getFatCaloriesPerServing())"></span> cal</div>
                        <div>Alcohol: <span x-text="Math.round(targets.alcohol * getAlcoholCaloriesPerServing())"></span> cal</div>
                    </div>
                    <div class="font-bold mt-2">
                        Total: <span x-text="targetCalories"></span> cal
                        <span class="text-sm font-normal text-gray-600">
                            (Suggested: <span x-text="Math.round(calorieExpenditure + (deltaLbPerWeek * 500))"></span> cal)
                        </span>
                    </div>
                </div>

                <button @click="saveSettings()"
                        :disabled="isSavingSettings"
                        :class="isSavingSettings ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-600'"
                        class="w-full bg-blue-500 text-white py-3 rounded-lg mt-4 font-semibold">
                    <span x-show="!isSavingSettings">Save Settings</span>
                    <span x-show="isSavingSettings">Saving...</span>
                </button>

                <!-- User Info and Logout -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            <p>Logged in as:</p>
                            <p class="font-semibold" x-text="user?.email || user?.username || 'User'"></p>
                        </div>
                        <button @click="logout()"
                                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weight Dialog -->
        <div x-show="showWeightDialog"
             x-cloak
             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
             @click.self="closeWeightDialog()">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Log Weight</h3>

                <!-- Weight Input -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Weight (lbs)</label>
                    <input type="number"
                           inputmode="decimal"
                           x-model="weightInput"
                           @keyup.enter="saveWeight()"
                           step="0.1"
                           placeholder="Enter weight"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2"
                           :disabled="isSavingWeight">
                </div>

                <!-- Error Message -->
                <div x-show="weightError" class="mb-4 bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded text-sm">
                    <p x-text="weightError"></p>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2">
                    <button @click="saveWeight()"
                            :disabled="isSavingWeight"
                            :class="isSavingWeight ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-600'"
                            class="flex-1 bg-blue-500 text-white py-2 rounded-lg font-semibold">
                        <span x-show="!isSavingWeight">Save</span>
                        <span x-show="isSavingWeight">Saving...</span>
                    </button>
                    <button @click="closeWeightDialog()"
                            :disabled="isSavingWeight"
                            class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Recompute Results Dialog -->
        <div x-show="showRecomputeResults"
             x-cloak
             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto"
             @click.self="closeRecomputeResults()">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full my-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">TDEE Recompute Results</h3>

                <!-- Calorie Intake Chart -->
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Daily Calorie Intake (Past Week)</h4>
                    <canvas id="calorieChart"></canvas>
                </div>

                <!-- Weight Chart -->
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Weight Trend (Past Week)</h4>
                    <canvas id="weightChart"></canvas>
                </div>

                <!-- TDEE Changes -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Previous TDEE</p>
                            <p class="text-2xl font-bold text-gray-800" x-text="previousTdee + ' cal'"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">New TDEE</p>
                            <p class="text-2xl font-bold text-blue-600" x-text="calorieExpenditure + ' cal'"></p>
                        </div>
                    </div>
                    <div class="mt-2 text-center">
                        <p class="text-sm text-gray-600">
                            Change: <span class="font-semibold"
                                          :class="(calorieExpenditure - previousTdee) > 0 ? 'text-green-600' : 'text-red-600'"
                                          x-text="(calorieExpenditure - previousTdee > 0 ? '+' : '') + (calorieExpenditure - previousTdee) + ' cal'"></span>
                        </p>
                    </div>
                </div>

                <!-- OK Button -->
                <button @click="closeRecomputeResults()"
                        class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600">
                    OK
                </button>
            </div>
        </div>
        </div>
    </div>

    <script src="js/app.js"></script>
</body>
</html>